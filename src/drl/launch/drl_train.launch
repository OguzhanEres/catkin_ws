<?xml version="1.0"?>
<launch>
  <arg name="mode" default="exploration"/>
  <arg name="epochs" default="10"/>
  <arg name="step_size" default="1.5"/>
  <arg name="takeoff_alt" default="3.0"/>
  <arg name="use_vision_bridge" default="true"/>
  <arg name="vision_model_name" default="iris_px4_sensors"/>
  <arg name="reset_each_epoch" default="true"/>
  <arg name="auto_arm" default="true"/>
  <arg name="use_px4_arm_takeoff" default="true"/>

  <!-- PX4 Arm/Takeoff node - runs first to arm and enter OFFBOARD mode -->
  <node pkg="drl" type="px4_arm_takeoff.py" name="px4_arm_takeoff" output="screen" if="$(arg use_px4_arm_takeoff)">
    <param name="takeoff_alt" value="$(arg takeoff_alt)"/>
    <param name="prestream_duration" value="3.0"/>
    <param name="arm_timeout" value="30.0"/>
    <param name="setpoint_rate" value="20.0"/>
  </node>

  <node pkg="drl" type="sensor_vectorizer_node.py" name="sensor_vectorizer" output="screen">
    <param name="lidar_topic" value="/scan"/>
    <param name="camera_topic" value="/front_camera/image_raw"/>
    <param name="imu_topic" value="/mavros/imu/data"/>
    <param name="gps_topic" value="/mavros/global_position/raw/fix"/>
    <!-- LiDAR processing params -->
    <param name="lidar_bins" value="180"/>
    <param name="lidar_fov_deg" value="120.0"/>  <!-- Wide FOV: Detect side obstacles (Safe limit < 68deg to avoid props) -->
    <param name="lidar_front_center_deg" value="0.0"/>
    <!-- Ground effect filter params -->
    <param name="pitch_ground_deg" value="15.0"/>  <!-- Pitch threshold for ground filter -->
    <param name="ground_min_range_m" value="0.25"/>  <!-- Min range to ignore when pitching (< collision_distance) -->
    <param name="use_dynamic_ground_filter" value="false"/>  <!-- Use altitude-based filter -->
    <param name="ground_margin" value="1.15"/>  <!-- Safety margin for dynamic filter -->
    <param name="debug_interval" value="0"/>  <!-- 0=disabled, N=log every N frames -->
    <!-- Camera params -->
    <param name="camera_width" value="32"/>
    <param name="camera_height" value="24"/>
  </node>

  <node pkg="drl" type="ppo_lstm_trainer_node.py" name="ppo_lstm_trainer" output="screen">
    <param name="mode" value="$(arg mode)"/>
    <param name="epochs" value="$(arg epochs)"/>
    <param name="loop_forever" value="true"/>
    <param name="checkpoint_path" value="$(find drl)/models/ppo_lstm_checkpoint.pt"/>
    <param name="auto_param_tune" value="false"/>
    <!-- Standard Learning Params -->
    <param name="lr" value="5e-5"/>
    <param name="entropy_coef" value="0.05"/>
    <param name="preflight_gate" value="true"/>
    <param name="preflight_timeout" value="45.0"/>
    <param name="preflight_stable_time" value="2.0"/>
    <param name="auto_arm" value="false"/>
    <param name="reset_each_epoch" value="$(arg reset_each_epoch)"/>
    <param name="disable_arming_checks" value="false"/>
    <param name="arm_attempts" value="6"/>
    <param name="frame_id" value="local_enu"/>
    <param name="route_length" value="3"/>
    <param name="step_size" value="$(arg step_size)"/>
    <param name="step_timeout" value="1.0"/>
    <param name="use_z_action" value="false"/>
    <param name="takeoff_alt" value="$(arg takeoff_alt)"/>
    <param name="min_takeoff_check_alt" value="1.5"/>
    <param name="send_takeoff_cmd" value="true"/>
    <param name="enforce_guided_only" value="true"/>
    <param name="required_mode" value="OFFBOARD"/>
    <param name="offboard_prestream_sec" value="2.0"/>
    <param name="allow_auto_mode" value="false"/>
    <param name="start_auto_after_takeoff" value="false"/>
    <param name="reset_wait" value="1.0"/>
    <!-- Initial target closer to spawn for easier early learning -->
    <!-- Spawn at (-25,-25), target at (-15,-15) = ~14m distance -->
    <param name="target_x" value="-15.0"/>
    <param name="target_y" value="-15.0"/>
    <param name="target_z" value="3.0"/>
    <param name="target_in_world" value="true"/>
    <!-- Larger goal radius for easier success -->
    <param name="goal_radius" value="5.0"/>
    <param name="spawn_x" value="-25.0"/>
    <param name="spawn_y" value="-25.0"/>
    <param name="spawn_z" value="0.1"/>
    <param name="spawn_yaw" value="0.785"/>
    <!-- Random spawn for training variety (breaks deterministic start trap) -->
    <param name="random_spawn" value="true"/>
    <rosparam param="spawn_area_x">[-30.0, -20.0]</rosparam>
    <rosparam param="spawn_area_y">[-30.0, -20.0]</rosparam>
    <param name="model_name" value="$(arg vision_model_name)"/>
    <!-- Map boundaries - generous to prevent instant OUT_OF_BOUNDS -->
    <param name="map_x_min" value="-35.0"/>
    <param name="map_x_max" value="30.0"/>
    <param name="map_y_min" value="-35.0"/>
    <param name="map_y_max" value="30.0"/>
    <param name="map_z_max" value="30.0"/>  <!-- Ceiling limit to prevent altitude escape -->
    <!-- Warmup: disable termination checks for first N steps (allow takeoff) -->
    <param name="warmup_steps" value="60"/>
    <!-- Collision distance - very low to prevent false positives from self-collision -->
    <param name="collision_distance" value="0.3"/>
    <!-- Robust LiDAR params -->
    <param name="lidar_max_range" value="10.0"/>  <!-- Must match sensor_vectorizer range_max -->
    <param name="collision_debounce_frames" value="3"/>  <!-- Require 2/3 frames for collision -->
    <param name="pitch_ground_deg" value="15.0"/>  <!-- Ignore low readings when pitching -->
    <!-- Quadratic proximity penalty params -->
    <param name="k_prox" value="2.0"/>  <!-- Penalty coefficient (higher = stronger avoidance) -->
    <param name="warning_distance" value="3.0"/>  <!-- Start penalty at this distance (meters) -->
    <!-- Minimum altitude before altitude crash (very low to allow takeoff fluctuations) -->
    <param name="min_alt" value="0.05"/>
    <param name="max_drift_distance" value="150.0"/>  <!-- Absolute failsafe (Map diagonal + margin) -->
  </node>

  <group if="$(arg use_vision_bridge)">
    <node pkg="drl" type="gazebo_vision_bridge.py" name="gazebo_vision_bridge" output="screen">
      <param name="model_name" value="$(arg vision_model_name)"/>
      <param name="frame_id" value="map"/>
      <param name="pose_topic" value="/mavros/vision_pose/pose"/>
      <param name="twist_topic" value="/mavros/vision_speed/speed_twist"/>
      <param name="publish_twist" value="true"/>
      <param name="publish_odom" value="true"/>
      <param name="odom_topic" value="/mavros/odometry/in"/>
    </node>
  </group>

  <node pkg="drl" type="ifds_smoother_node.py" name="ifds_smoother" output="screen">
    <param name="alpha" value="0.35"/>
    <param name="route_in" value="/agent/route_raw"/>
    <param name="route_out" value="/agent/route_smoothed"/>
  </node>

  <node pkg="drl" type="setpoint_follower_node.py" name="setpoint_follower" output="screen">
    <param name="route_topic" value="/agent/route_smoothed"/>
    <param name="acceptance_radius" value="0.5"/>
    <param name="pose_topic" value="/mavros/local_position/pose"/>
    <param name="setpoint_topic" value="/mavros/setpoint_position/local"/>
    <param name="reached_topic" value="/agent/wp_reached"/>
    <param name="publish_rate" value="20.0"/>
    <param name="frame_id" value="map"/>
    <param name="force_enu" value="true"/>
    <param name="takeoff_alt" value="$(arg takeoff_alt)"/>
    <param name="max_target_z" value="$(arg takeoff_alt)"/>
    <param name="max_xy_step" value="$(arg step_size)"/>
    <param name="min_alt_for_control" value="0.5"/>
    <param name="require_armed" value="false"/>
    <param name="require_guided" value="false"/>
    <param name="required_mode" value="OFFBOARD"/>
  </node>

  <node pkg="drl" type="target_marker_node.py" name="target_marker" output="screen" >
    <param name="model_name" value="target_marker_red"/>
    <param name="model_path" value="$(find ardupilot_city_sim)/models/target_marker_red/model.sdf"/>
    <param name="setpoint_topic" value="/agent/goal_pose"/>
    <param name="frame_id" value="map"/>
  </node>

  <!-- TF: Transforms for RViz visualization -->
  <!-- map = local_enu (identity transform) -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="tf_map_local_enu"
        args="0 0 0 0 0 0 map local_enu"/>
  <!-- odom_ned = map (identity, NED frame alias) -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="tf_map_odom_ned"
        args="0 0 0 0 0 0 map odom_ned"/>
  <!-- Drone pose to TF (converts /mavros/local_position/pose to TF) -->
  <node pkg="drl" type="pose_to_tf.py" name="pose_to_tf" output="screen">
    <param name="pose_topic" value="/mavros/local_position/pose"/>
    <param name="parent_frame" value="map"/>
    <param name="child_frame" value="base_link"/>
  </node>
  <!-- lidar_link is at front of drone (matches SDF: 0.18m forward) -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="tf_base_lidar"
        args="0.18 0 0.12 0 0 0 base_link lidar_link"/>

  <!-- RViz visualization -->
  <arg name="rviz" default="true"/>
  
  <!-- Robot description for RViz model visualization -->
  <param name="robot_description" command="$(find xacro)/xacro $(find drl)/urdf/quadcopter.urdf.xacro"/>
  <node pkg="robot_state_publisher" type="robot_state_publisher" name="robot_state_publisher">
    <param name="publish_frequency" value="50"/>
  </node>
  
  <node pkg="rviz" type="rviz" name="rviz" args="-d $(find drl)/rviz/drl_training.rviz" if="$(arg rviz)" output="screen"/>
</launch>
